[gd_scene load_steps=2 format=3 uid="uid://circuit_track"]

[ext_resource type="Script" path="res://src/racing/race_track.gd" id="1"]

[node name="CircuitTrack" type="Node3D"]
script = ExtResource("1")
is_circuit = true
lap_count = 3

; ---- Racing Line (closed loop with varied corner types) ----
; Layout: Start/finish straight -> Hairpin -> Short straight -> Chicane ->
; Sweeper -> Back straight -> Esses -> Long sweeper -> Return to start
[node name="RacingLine" type="Path3D" parent="."]
curve = SubResource("Curve3D_circuit")

; ---- Start / Finish Line ----
[node name="FinishLine" type="Area3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="FinishLine"]
shape = SubResource("BoxShape_circuit_finish")

[node name="FinishLabel" type="Label3D" parent="FinishLine"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 3, 0)
text = "START / FINISH"
font_size = 48
modulate = Color(1, 1, 0, 1)

; ---- Checkpoints (8 around the circuit) ----
[node name="Checkpoints" type="Node3D" parent="."]

; CP0 — After start straight, approaching hairpin
[node name="CP0" type="Area3D" parent="Checkpoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 60)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="Checkpoints/CP0"]
shape = SubResource("BoxShape_circuit_cp")

; CP1 — Exit of hairpin
[node name="CP1" type="Area3D" parent="Checkpoints"]
transform = Transform3D(0, 0, -1, 0, 1, 0, 1, 0, 0, -30, 1, 80)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="Checkpoints/CP1"]
shape = SubResource("BoxShape_circuit_cp")

; CP2 — Through chicane
[node name="CP2" type="Area3D" parent="Checkpoints"]
transform = Transform3D(0, 0, -1, 0, 1, 0, 1, 0, 0, -60, 1, 60)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="Checkpoints/CP2"]
shape = SubResource("BoxShape_circuit_cp")

; CP3 — Mid-sweeper
[node name="CP3" type="Area3D" parent="Checkpoints"]
transform = Transform3D(0.707, 0, -0.707, 0, 1, 0, 0.707, 0, 0.707, -80, 1, 30)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="Checkpoints/CP3"]
shape = SubResource("BoxShape_circuit_cp")

; CP4 — Start of back straight
[node name="CP4" type="Area3D" parent="Checkpoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -80, 1, -10)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="Checkpoints/CP4"]
shape = SubResource("BoxShape_circuit_cp")

; CP5 — End of back straight, entering esses
[node name="CP5" type="Area3D" parent="Checkpoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -80, 1, -60)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="Checkpoints/CP5"]
shape = SubResource("BoxShape_circuit_cp")

; CP6 — Through esses
[node name="CP6" type="Area3D" parent="Checkpoints"]
transform = Transform3D(0, 0, 1, 0, 1, 0, -1, 0, 0, -50, 1, -80)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="Checkpoints/CP6"]
shape = SubResource("BoxShape_circuit_cp")

; CP7 — Long sweeper return
[node name="CP7" type="Area3D" parent="Checkpoints"]
transform = Transform3D(0.707, 0, 0.707, 0, 1, 0, -0.707, 0, 0.707, -20, 1, -50)
collision_layer = 32

[node name="CollisionShape3D" type="CollisionShape3D" parent="Checkpoints/CP7"]
shape = SubResource("BoxShape_circuit_cp")

; ---- Spawn Points (grid start — 2x3 grid) ----
[node name="SpawnPoints" type="Node3D" parent="."]

[node name="P1" type="Marker3D" parent="SpawnPoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -2, 1, -5)

[node name="P2" type="Marker3D" parent="SpawnPoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 1, -5)

[node name="P3" type="Marker3D" parent="SpawnPoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -2, 1, -10)

[node name="P4" type="Marker3D" parent="SpawnPoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 1, -10)

[node name="P5" type="Marker3D" parent="SpawnPoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -2, 1, -15)

[node name="P6" type="Marker3D" parent="SpawnPoints"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 1, -15)

; ---- Pit Lane ----
[node name="PitLane" type="Node3D" parent="."]

; Pit entry/exit area trigger
[node name="PitArea" type="Area3D" parent="PitLane"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 12, 1, -10)
collision_layer = 64

[node name="CollisionShape3D" type="CollisionShape3D" parent="PitLane/PitArea"]
shape = SubResource("BoxShape_pit_area")

[node name="PitLabel" type="Label3D" parent="PitLane/PitArea"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 3, 0)
text = "PIT LANE"
font_size = 36
modulate = Color(0, 0.8, 1, 1)

; Pit wall barrier
[node name="PitWall" type="StaticBody3D" parent="PitLane"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 8, 0.5, -10)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="PitLane/PitWall"]
mesh = SubResource("BoxMesh_pitwall")
material_override = SubResource("mat_pitwall")

[node name="Collision" type="CollisionShape3D" parent="PitLane/PitWall"]
shape = SubResource("BoxShape_pitwall")

; Pit boxes (visual only for now)
[node name="PitBox1" type="MeshInstance3D" parent="PitLane"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 15, 0, -5)
mesh = SubResource("BoxMesh_pitbox")
material_override = SubResource("mat_pitbox")

[node name="PitBox2" type="MeshInstance3D" parent="PitLane"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 15, 0, -10)
mesh = SubResource("BoxMesh_pitbox")
material_override = SubResource("mat_pitbox")

[node name="PitBox3" type="MeshInstance3D" parent="PitLane"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 15, 0, -15)
mesh = SubResource("BoxMesh_pitbox")
material_override = SubResource("mat_pitbox")

; ---- Track Barriers ----
[node name="Barriers" type="Node3D" parent="."]

; Start/finish straight — right side
[node name="BarrierStartR" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 7, 0.6, 30)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierStartR"]
mesh = SubResource("BoxMesh_barrier_long")
material_override = SubResource("mat_barrier")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierStartR"]
shape = SubResource("BoxShape_barrier_long")

; Start/finish straight — left side
[node name="BarrierStartL" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -7, 0.6, 30)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierStartL"]
mesh = SubResource("BoxMesh_barrier_long")
material_override = SubResource("mat_barrier")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierStartL"]
shape = SubResource("BoxShape_barrier_long")

; Hairpin outer wall
[node name="BarrierHairpin" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(0, 0, -1, 0, 1, 0, 1, 0, 0, -15, 0.6, 85)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierHairpin"]
mesh = SubResource("BoxMesh_barrier_medium")
material_override = SubResource("mat_barrier_red")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierHairpin"]
shape = SubResource("BoxShape_barrier_medium")

; Chicane barriers
[node name="BarrierChicaneA" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(0.866, 0, -0.5, 0, 1, 0, 0.5, 0, 0.866, -50, 0.6, 70)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierChicaneA"]
mesh = SubResource("BoxMesh_barrier_short")
material_override = SubResource("mat_barrier_red")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierChicaneA"]
shape = SubResource("BoxShape_barrier_short")

[node name="BarrierChicaneB" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(0.866, 0, -0.5, 0, 1, 0, 0.5, 0, 0.866, -55, 0.6, 55)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierChicaneB"]
mesh = SubResource("BoxMesh_barrier_short")
material_override = SubResource("mat_barrier_red")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierChicaneB"]
shape = SubResource("BoxShape_barrier_short")

; Sweeper outer
[node name="BarrierSweeper" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(0.707, 0, -0.707, 0, 1, 0, 0.707, 0, 0.707, -90, 0.6, 15)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierSweeper"]
mesh = SubResource("BoxMesh_barrier_long")
material_override = SubResource("mat_barrier")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierSweeper"]
shape = SubResource("BoxShape_barrier_long")

; Back straight barriers
[node name="BarrierBackR" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -73, 0.6, -35)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierBackR"]
mesh = SubResource("BoxMesh_barrier_long")
material_override = SubResource("mat_barrier")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierBackR"]
shape = SubResource("BoxShape_barrier_long")

[node name="BarrierBackL" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -87, 0.6, -35)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierBackL"]
mesh = SubResource("BoxMesh_barrier_long")
material_override = SubResource("mat_barrier")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierBackL"]
shape = SubResource("BoxShape_barrier_long")

; Esses barriers
[node name="BarrierEssesOuter" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(0, 0, 1, 0, 1, 0, -1, 0, 0, -60, 0.6, -75)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierEssesOuter"]
mesh = SubResource("BoxMesh_barrier_medium")
material_override = SubResource("mat_barrier_red")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierEssesOuter"]
shape = SubResource("BoxShape_barrier_medium")

; Return sweeper
[node name="BarrierReturn" type="StaticBody3D" parent="Barriers"]
transform = Transform3D(0.707, 0, 0.707, 0, 1, 0, -0.707, 0, 0.707, -15, 0.6, -65)
collision_layer = 2

[node name="Mesh" type="MeshInstance3D" parent="Barriers/BarrierReturn"]
mesh = SubResource("BoxMesh_barrier_long")
material_override = SubResource("mat_barrier")

[node name="Collision" type="CollisionShape3D" parent="Barriers/BarrierReturn"]
shape = SubResource("BoxShape_barrier_long")

; ---- Sub-Resources ----

; Circuit racing line: closed loop with hairpin, chicane, sweeper, esses
; Approximate layout coordinates for a ~600m track
[sub_resource type="Curve3D" id="Curve3D_circuit"]
_data = {
"points": PackedVector3Array(0, 0, 0, 0, 0, 0, 0, 0.5, 0, 0, 0, -5, 0, 0, 5, 0, 0.5, 30, 0, 0, -5, 0, 0, 5, 0, 0.5, 60, -10, 0, 0, 10, 0, 0, -10, 0.5, 80, -10, 0, 0, -5, 0, -5, -30, 0.5, 80, 0, 0, -10, 0, 0, 10, -45, 0.5, 70, 5, 0, -5, -5, 0, 5, -55, 0.5, 55, -5, 0, -10, 5, 0, 10, -70, 0.5, 40, -10, 0, -5, 10, 0, 5, -80, 0.5, 20, 0, 0, -10, 0, 0, 10, -85, 0.5, 0, 0, 0, -10, 0, 0, 10, -80, 0.5, -20, 0, 0, -10, 0, 0, 10, -80, 0.5, -50, 5, 0, -10, -5, 0, 10, -75, 0.5, -70, 10, 0, 0, -10, 0, 0, -60, 0.5, -80, 10, 0, 5, -10, 0, -5, -40, 0.5, -75, 5, 0, 10, -5, 0, -10, -25, 0.5, -55, 10, 0, 5, -10, 0, -5, -10, 0.5, -35, 5, 0, -10, -5, 0, 10, 0, 0.5, -15, 0, 0, 5, 0, 0, -5, 0, 0.5, 0),
"tilts": PackedFloat32Array(0, 0, 0, -0.05, 0, 0, -0.02, 0.02, -0.03, 0, 0, 0, 0, -0.03, 0.03, -0.02, 0.02, 0, 0)
}

; Finish / checkpoint shapes
[sub_resource type="BoxShape3D" id="BoxShape_circuit_finish"]
size = Vector3(14, 4, 2)

[sub_resource type="BoxShape3D" id="BoxShape_circuit_cp"]
size = Vector3(14, 4, 2)

; Pit area
[sub_resource type="BoxShape3D" id="BoxShape_pit_area"]
size = Vector3(8, 4, 20)

; Pit wall
[sub_resource type="BoxMesh" id="BoxMesh_pitwall"]
size = Vector3(0.3, 1.0, 20)

[sub_resource type="BoxShape3D" id="BoxShape_pitwall"]
size = Vector3(0.3, 1.0, 20)

[sub_resource type="StandardMaterial3D" id="mat_pitwall"]
albedo_color = Color(0.8, 0.8, 0.8, 1)
roughness = 0.5

; Pit box visual
[sub_resource type="BoxMesh" id="BoxMesh_pitbox"]
size = Vector3(4, 0.05, 4)

[sub_resource type="StandardMaterial3D" id="mat_pitbox"]
albedo_color = Color(0.2, 0.2, 0.25, 1)
roughness = 0.8

; Barriers
[sub_resource type="BoxMesh" id="BoxMesh_barrier_long"]
size = Vector3(0.5, 1.2, 60)

[sub_resource type="BoxShape3D" id="BoxShape_barrier_long"]
size = Vector3(0.5, 1.2, 60)

[sub_resource type="BoxMesh" id="BoxMesh_barrier_medium"]
size = Vector3(0.5, 1.2, 30)

[sub_resource type="BoxShape3D" id="BoxShape_barrier_medium"]
size = Vector3(0.5, 1.2, 30)

[sub_resource type="BoxMesh" id="BoxMesh_barrier_short"]
size = Vector3(0.5, 1.2, 10)

[sub_resource type="BoxShape3D" id="BoxShape_barrier_short"]
size = Vector3(0.5, 1.2, 10)

[sub_resource type="StandardMaterial3D" id="mat_barrier"]
albedo_color = Color(0.3, 0.3, 0.35, 1)
roughness = 0.7

[sub_resource type="StandardMaterial3D" id="mat_barrier_red"]
albedo_color = Color(0.7, 0.15, 0.1, 1)
roughness = 0.6
